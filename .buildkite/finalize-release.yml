# Nodes with values to reuse in the pipeline.
common_params:
  # Common plugin settings to use with the `plugins` key.
  - &common_plugins
    - automattic/a8c-ci-toolkit#2.15.0

steps:
  - label: "Finalize release"
    command: |
      curl -L https://api.github.com/meta | jq -r '.ssh_keys | .[]' | sed -e 's/^/github.com /' >> ~/.ssh/known_hosts
      git config --global user.email "mobile@automattic.com"
      git config --global user.name "Buildkite"

      if [[ -z "${RELEASE_VERSION}" ]]; then
        echo "RELEASE_VERSION is not set."
        exit 1
      fi

      # We need to be on a release brnach before finalizing the release. We can't be in a detached HEAD.
      git checkout release/${RELEASE_VERSION}

      bundle install

      bundle exec fastlane finalize_release skip_confirm:true
